<style>
    .pagesize{float: left;}
    .totalcount{ padding: 9px 12px 0px 5px; line-height: 20px;}
    .search label{display: inline;}
    .searchbutton{ margin-top: -9px; text-align: center; font-size: 14px; height: 30px;line-height:      30px;width: 60px;}
    .search>div{ display: inline;}
    .searchbox{  margin-left: 10px;margin-right: 0;}
    #pagesize{width: 70px;}

    .ddd li{display: inline;}

    .table > thead > tr > th {color: #563d7c; background-color: #f8f6fa;}
    .table > tbody > tr > td {height: 21px; line-height: 21px;}
    .table-striped tbody>tr:nth-child(even)>td,
    .table-striped tbody>tr:nth-child(even)>th{background-color:#f8f6fa;}
    .table-striped tbody>tr:nth-child(odd)>td,
    .table-striped tbody>tr:nth-child(odd)>th{background-color:transparent;}
    .table-hover tbody tr:hover>td,.table-hover tbody tr:hover>th{background-color:#f5f5f5}
    .search button{color:#563d7c; background-color:#f8f6fa; border-color:#927ab5;}
    .search button:hover, .search button:focus, .search button:active,
    .search button.active{color:#FFF; background-color:#927ab5; border-color:#927ab5;}
</style>

<div class="portlet">

    <div class="portlet-title">
        <!--列表 头部信息-->
        <div class="caption"><i class="icon-reorder"></i>数据字典</div>
        <div class="actions tabletools">
            <a href="#" class="btn blue" id="roleadd"><i class="icon-plus"></i> 新增</a>
            <div class="btn-group ">
                <a class="btn green" href="#" data-toggle="dropdown">
                    <i class="icon-cogs"></i> 操作
                    <i class="icon-angle-down"></i>
                </a>
                <ul class="dropdown-menu pull-right">
                    <li><a href="javascript:;" id="roleupdate"><i class="icon-pencil"></i> 编辑</a></li>
                    <li><a href="javascript:;" id="roledelete"><i class="icon-trash"></i> 删除</a></li>
                    <li><a href="javascript:;" id="roleview"><i class="icon-file"></i> 查看</a></li>

                </ul>
            </div>
        </div>
    </div>

    <div class="portlet-body">

        <div class="clearfix search">
            <!-- xiala  start -->
            <div class="portlet">
                <div class="portlet-title">
                    <label >字典名称：
                        <input type="text" id="dicName"  name="dicName" placeholder="字典名称"/>
                    </label>
					<label >字典码：
                        <input type="text" id="dicCode"  name="dicCode" placeholder="字典码"/>
                    </label>
                    <button  class="searchbutton" id="searchbutton" ><i class="icon-search"></i>检索</button>
                </div>

            </div>

            <!-- xiala  end-->

        </div>

        <!--  表头的 自己画-->
        <table class="table table-striped table-bordered table-hover systable" id="roletable">
            <thead>
            <tr>
                <th style="width:8px;"><input type="checkbox" class="group-checkable" data-set="#sample_1 .checkboxes" /></th>
                <th style="width:40px;">序号</th>
                <th >字典名称</th>
                <th>字典编码</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination pagination-right pagination-bottom" >
            <div class="pagesize">
                每页<select  id="pagesize" name="pagesize"  ></select>条,
                <span class="totalcount" id="totalcount" ></span>
            </div>

            <div style="display: inline; " id="text"></div>
            <ul id="paglist" ></ul>
            <!--<span class="totalcount" id="totalcount" ></span>-->
        </div>

    </div>
</div>

<div id="rolecrud" class="form">
    <!-- form表单要自己设计内容。 -->
    <form role="form" id="roleform" name="roleform" class="form-horizontal">
        <div class="control-group"><input type="hidden" id="ridadd" name="id" /></div>
        <div class="control-group">
            <label class="control-label" >字典名称：</label>
            <div class="controls">
                <input type="text"  name="dictionaryName" placeholder="字典名称">
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >字典编码：</label>
            <div class="controls">
                <input type="text"  name="dictionaryCode" placeholder="字典编码">
            </div>
        </div>
    </form>
</div>

<div id="subDicTabel">
    <div class="actions fieldtabletools">
        <a href="javascript:;" class="btn btn-primary" id="dicAdd" rbut="add"><i class="fa fa-plus"></i> 新增</a>
        <a href="javascript:;" class="btn btn-primary" id="dicUpdate" rbut="update"><i class="fa fa-pencil"></i> 编辑</a>
        <a href="javascript:;" class="btn btn-primary" id="dicDelete" rbut="delete"><i class="fa fa-trash-o"></i> 删除</a>
        <!--<div class="btn-group ">
            <a class="btn blue" href="#" data-toggle="dropdown">

                <i class="icon-cogs"></i> 操作
                <i class="icon-angle-down"></i>
            </a>
            <ul class="dropdown-menu pull-right">

            </ul>
        </div>-->
    </div>
    <table class="table table-striped table-bordered table-hover systable" id="dicTypeTable" style="width:580px">
        <thead>
        <tr>
            <th style="width:8px;"><input type="checkbox" class="group-checkable" data-set="#sample_1 .checkboxes1" /></th>
            <th style="width:15px;">#</th>
            <th>类型名称</th>
            <th>类型编码</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="pagination ">
        <div class="pagesize" style="width:180px;">
            每页<select id="userFieldTablePageSize" name="userFieldTablePageSize" style="width:50px"></select>条,
            <span class="totalcount" id="userFieldTableTotalcount" ></span>
        </div>

        <nav aria-label="Page navigation" style="float: right;margin-top:-11px">
            <ul id="userFieldTablePagelist"  style="float: left;margin-top:-1px"  class="pagination">  </ul>
        </nav>
    </div>
</div>
<div id="dicTypeCrud" class="form">
    <!-- form表单要自己设计内容。 -->
    <form role="form" id="dicTypeform" name="dicTypeform" class="form-horizontal">
        <div class="control-group"><input type="hidden" id="dicTypeId" name="id" /></div>
        <div class="control-group">
            <label class="control-label" >类型名称：</label>
            <div class="controls">
                <input type="text"  name="dicTypeName" placeholder="类型名称">
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >类型编码：</label>
            <div class="controls">
                <input type="text"  name="dicTypeCode" placeholder="类型编码">
            </div>
        </div>
    </form>
</div>

<script>
    /* 默认隐藏弹出表单*/
    $('.tt').hide();
    $('#subDicTabel').hide();
    $('#dicTypeCrud').hide();
    var pageSize =5, pageNo=1, totalCounts = 1, myid ="role" , myname="字典",type_id="type";
    var tid = "dicTypeTable",dicTypeTotalCounts = 1,dicTypePageSize =5, dicTypePageNo=1;
    var url ='';
    var searchmsg = {dicname:'',diccode:''};
    var pagearr = [5,10,15,20];
    $("#"+myid+"crud").hide();
    $("#"+type_id+"crud").hide();
    // 获取列表数据
    var getlist = function(type ){
        url = addr+"/api/sys/dictionary?pageNo="+pageNo+"&pageSize="+pageSize+"&dicName="+searchmsg.dicname+"&dicCode="+searchmsg.diccode;
//         debugger;
        $.ajax({
            url: url ,
            type:"GET",
            dataType:'json',
            success:function (data) {
                if( typeof(data) == 'string' || typeof(data) == "" ){}
                getcolumns(data,type);
                //searchmsg="";
            },
            error:function(){
                var str ="";
                for(var i=0 ;i<pageSize; i ++){
                    str+= "<tr ><td style='height: 20px;'>" +
                        "</td>"
                        + "<td style=''></td><td></td><td></td> <td></td><td></td><td></td></tr>";
                }
                $("#"+myid+"table tbody").html(str);
                $('#totalcount').html('共 '+ 0 +" 条");
                console.log(arguments);
            }
        });
    };

    //获取列信息
    function getcolumns(data,type) {
//         debugger;
        var cur = data.data.list || '', str="";
        totalCounts = data.data.count|| 1;
        pagecoount = data.data.pageCount;
        var id ,rname,rdesc,usercount,status;
        var chebox  = '', numbox='';
        if(type != 'change') {
            setjqpage();
        }
        for(var i=0 ;i<pageSize; i ++){
            try{
//                 debugger;
                if(i < cur.length ){
                    id = cur[i].id;
                    dictionaryName = cur[i].dictionaryName;
                    dictionaryCode = cur[i].dictionaryCode;
                    chebox  = "<input type='checkbox' name='checkboxes' class='checkboxes' rowno = '"+ i +"' value='"+ id +"' />";
                    numbox =  parseInt(i+1);
                }else {
                    id = dictionaryName = dictionaryCode="" ;
                    chebox = '';
                    numbox = '';
                }
            }catch (ex) {
                rid= rname = rdesc = usercount = status = "";
                console.log('错误' + ex.message );
            }
//             debugger;
            str+= "<tr><td >"+chebox+"</td>"
                + "<td>"+ numbox +"</td>"
                + "<td>"+ dictionaryName +"</td><td>"+ dictionaryCode +"</td></tr>";
        }
        $("#"+myid+"table tbody").html(str);
    }

    setjqpage();
    //分页设置
    function setjqpage() {
        pageSize = parseInt(pageSize);
        $('#paglist').jqPaginator({
            totalCounts:totalCounts,
            pageSize:pageSize,
            visiblePages: 5,
            currentPage: pageNo,
            first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
            prev: '<li class="prev"><a href="javascript:void(0);">上一页</a></li>',
            next: '<li class="next"><a href="javascript:void(0);">下一页</a></li>',
            last: '<li class="last"><a href="javascript:void(0);">尾页</a></li>',
            page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',

            onPageChange: function (num,type) {
                pageNo = num;
                if(type == 'change') getlist('change');

//                $('#text').html('当前第' + num + '页');
//                $('#totalcount').html('共 '+ Math.ceil(totalCounts/pageSize) +" 页");
                $('#totalcount').html('共 '+ Math.ceil(totalCounts) +" 条");
            }
        });
    }

    function getpagesize(){
        var pagesizearr='';
        for(var i  in pagearr){
            pagesizearr +='<option value = "'+ pagearr[i] +'">'+ pagearr[i]+'</option>'
        }
        $('#pagesize').html(pagesizearr).val(pageSize);
    }

    getlist('init');
    getpagesize();
    // 全选
    $(".group-checkable").change(function () {
        var isChecked = $(this).prop("checked");
        $("input[name='checkboxes']").prop("checked", isChecked);
    });

    //每页显示条数
    $("#pagesize").on('change',function () {
        if(pageSize != $(this).val()){
            pageSize =  $(this).val();
            pageNo = 1;
            getlist('init');
        }
    });
    
    // 搜索
    $("#searchbutton").on('click',function (data) {
        pageNo = 1;
        searchmsg.dicname = $("#dicName").val()
        searchmsg.diccode = $("#dicCode").val()
        getlist('init');
    });
    // 工具栏 点击弹窗
    $(".tabletools").on('click','a',function () {
        var html= "",title ="",htmlstr = $("#"+myid+"crud");
        var checkboxs = $("input[name='checkboxes']:checked");

        switch ($(this)[0].id){
            case myid+'add':
                title = "新增"+myname+"信息";
                layerfn(htmlstr,title,'add');
                break;
            case myid+'update':
                title = "修改"+myname+"信息";
                if(checkboxs.length == 1 ){
                    getform(checkboxs.val(),htmlstr,title,'update');
                }else {
                    layer.msg("请选择一条记录！");
                }
                break;
            case myid+'delete':
                title = "删除"+myname+"信息";
                if(checkboxs.length ){
                    dellist(checkboxs.val());
                }else {
                    layer.msg("请选择一条记录！");
                }
                break;
            case myid+'view':
                title = "查看"+myname+"信息";
                
                if(checkboxs.length == 1 ){
                	dicTypeTotalCounts = 1,dicTypePageSize =5, dicTypePageNo=1;
                	getDicTypelist('init',checkboxs.val());
                    setfieldjqpage();
                    getfieldpagesize();
                    htmlstr = $("#subDicTabel");
                   // title = "附表管理";
                    layerfnSubDicTable(htmlstr, title);
                   // getform(checkboxs.val(),$("#subDicTabel"),title,'view');
                }else {
                    layer.msg("请选择一条记录！");
                }
                break;
        }
    });
    
    $(".fieldtabletools").on('click','a',function () {
        var html= "",title ="",htmlstr = $("#dicTypeCrud");
        var checkboxs = $("input[name='checkboxes1']:checked");

        switch ($(this)[0].id){
            case 'dicAdd':
                title = "新增字典类型信息";
                layerfnDicType(htmlstr,title,'add');
                break;
            case 'dicUpdate':
                title = "修改字典类型信息";
                if(checkboxs.length == 1 ){
                	getDicTypeForm(checkboxs.val(),htmlstr,title,'update');
                }else {
                    layer.msg("请选择一条记录！");
                }
                break;
            case 'dicDelete':
                title = "删除字典类型信息";
                var chk_value = [];
                checkboxs.each(function(){
                    chk_value.push($(this).val());
                });
                if($("input[name='checkboxes1']:checked").length ){
                    dellistDictype(chk_value);
                }else {
                    layer.msg("请选择一条记录！");
                }
                break;
           
        }
    });
    
    function layerfnSubDicTable(htmlstr, title){
    	//alert(1);
        layer.open({
            type: 1,
            title: title,
            skin: 'ayui-layer-molv,demo-class', //加上边框
            area: ['700px', '500px'], //宽高
            content: htmlstr,
            anim: 2, //弹出动画
            shadeClose: false//, //开启遮罩关闭
            //  btn: ['提交', '重置', '关闭'],
        });
    }
    function setfieldjqpage() {
    	dicTypePageSize = parseInt(dicTypePageSize);
        $('#userFieldTablePagelist').jqPaginator({
            totalCounts:dicTypeTotalCounts,
            pageSize:dicTypePageSize,
            visiblePages: 5,
            currentPage: dicTypePageNo,
            first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
            prev: '<li class="prev"><a href="javascript:void(0);">上一页</a></li>',
            next: '<li class="next"><a href="javascript:void(0);">下一页</a></li>',
            last: '<li class="last"><a href="javascript:void(0);">尾页</a></li>',
            page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',
            onPageChange: function (num,type) {
            	dicTypePageNo = num;
                if(type == 'change') {
                	getDicTypelist('change',$("input[name='checkboxes']:checked").val());
                }
                var pagesizearr='';
                for(var i  in pagearr){
                    pagesizearr +='<option value = "'+ pagearr[i] +'">'+ pagearr[i]+'</option>'
                }
//                $('#text').html('当前第' + num + '页');
                // $('#totalcount').html('共 '+ Math.ceil(totalCounts/pageSize) +" 页");
                $('#userFieldTableTotalcount').html('共 ' + Math.ceil(dicTypeTotalCounts) + " 条");
                $('#userFieldTablePageSize').html(pagesizearr).val(dicTypePageSize);
            }
        });
    }
    
    
    function getfieldpagesize() {
        var pagesizearr = '';
        for (var i  in pagearr) {
            pagesizearr += '<option value = "' + pagearr[i] + '">' + pagearr[i] + '</option>'
        }
        $('#userFieldTablePageSize').html(pagesizearr).val(dicTypePageSize);
    }
  //每页显示条数
    $("#userFieldTablePageSize").on('change',function () {
        if(dicTypePageSize != $(this).val()){
        	dicTypePageSize =  $(this).val();
        	dicTypepageNo = 1;
        	getDicTypelist('init',$("input[name='checkboxes']:checked").val());
        }
    });
    var getDicTypelist = function(type,dicId){
        // url =addr+"/api/sys/tuser?pageNo="+pageNo+"&pageSize="+pageSize
        //      + "&usname="+searchmsg.usname+ "&rolestr="+searchmsg.rolestr;
        url = addr+"/api/sys/dictype/page?pageNo="+dicTypePageNo+"&pageSize="+dicTypePageSize+"&dicId="+dicId;
        $.ajax({
            url: url ,
            type:"GET",
            async:false,
            success:function (data) {
                var cur = data.data.list, str="",dicTypeName="";
                var dicTypeCode="",id="";
                dicTypeTotalCounts = data.data.count|| 1;
                pagecount = data.data.pageCount;
                if(type != 'change') {
                    setfieldjqpage();
                } 

                for(var i=0 ;i<cur.length; i ++){

                    id= cur[i].id;
                    dicTypeName = cur[i].dicTypeName;
                    dicTypeCode = cur[i].dicTypeCode;
                   

                    str+= "<tr><td><input type='checkbox' name='checkboxes1' class='checkboxes' rowno = '"+i+"' value='"+id+"' /></td>"
                        + "<td>"+parseInt(i+1)+"</td>"
                        + "<td>"+dicTypeName+"</td><td>"+dicTypeCode+"</td>";
                       
                    str+="</tr>";
                }
                $("#"+tid+" tbody").html(str);
            }
        });
    }
    
    //弹窗
    function layerfn(htmlstr,title,type) {
        $("#"+myid+"form")[0].reset();
        var btn = [];
        if(type != 'view'){
            btn = [ '提交','重置', '关闭'];
        }
        layer.open({
            type: 1,
            title:title,
            skin: 'ayui-layer-molv,demo-class', //加上边框
            area: ['480px', '300px'], //宽高
            content: htmlstr,
            anim: 2, //弹出动画
            shadeClose: false, //开启遮罩关闭
            btn: btn,
            btnAlign:'b',
            btn1: function(index, layero){

                var fmsg = $("#"+myid+"form").serializeArray();
                fmsg[0].value = $("input[name='checkboxes']:checked").val();
                var params ="{";
                for(var i in fmsg){
                    params+="\""+ fmsg[i].name+"\":\""+fmsg[i].value+"\"" ;
                    if(i<fmsg.length-1){params +=',';}
                }
                params += ",\"dicTypeEOList\": []}";
                if(type == 'add'){
                    addlist(addr+"/api/sys/dictionary","POST",params,'新增');
                }else{
                    addlist(addr+"/api/sys/dictionary","PUT",params,'修改');
                }

                $("#"+myid+"form")[0].reset;
                layer.closeAll();
            } ,
            btn2: function(index, layero){
                $("#"+myid+"form")[0].reset;
                return false //开启该代码可禁止点击该按钮关闭
            } ,
            btn3: function(index, layero){
                $("#"+myid+"form")[0].reset;
                $("input[name='checkboxes']:checked").prop("checked", false);
            }
        });
    }
    
    function layerfnDicType(htmlstr,title,type) {
        $("#dicTypeform")[0].reset();
        var btn = [];
        if(type != 'view'){
            btn = [ '提交','重置', '关闭'];
        }
        var dicType = layer.open({
            type: 1,
            title:title,
            skin: 'ayui-layer-molv,demo-class', //加上边框
            area: ['480px', '300px'], //宽高
            content: htmlstr,
            anim: 2, //弹出动画
            shadeClose: false, //开启遮罩关闭
            btn: btn,
            btnAlign:'b',
            btn1: function(index, layero){

                var fmsg = $("#dicTypeform").serializeArray();
                fmsg[0].value = $("input[name='checkboxes1']:checked").val();
                var params ="{";
                for(var i in fmsg){
                    params+="\""+ fmsg[i].name+"\":\""+fmsg[i].value+"\"" ;
                    if(i<fmsg.length-1){params +=',';}
                }
              //  params = params+"}";
                params += ",\"dicId\":\""+$("input[name='checkboxes']:checked").val()+"\"}";
                if(type == 'add'){
                    addlist(addr+"/api/sys/dictype","POST",params,'新增');
                }else{
                    addlist(addr+"/api/sys/dictype","PUT",params,'修改');
                }

                $("#dicTypeform")[0].reset;
                layer.close(dicType);
            } ,
            btn2: function(index, layero){
                $("#dicTypeform")[0].reset;
                return false //开启该代码可禁止点击该按钮关闭
            } ,
            btn3: function(index, layero){
                $("#dicTypeform")[0].reset;
                $("input[name='checkboxes']:checked").prop("checked", false);
            }
        });
    }
    //增修保存信息
    function addlist(url,type,param, msg) {
//         debugger;
        var obj = eval("("+param+")");
        $.ajax({
            url:url,
            type:type,
            data: param,
            contentType:"application/json; charset=UTF-8",
            success:function (data) {
                if(data.ok){
                	if(!obj.hasOwnProperty("dicId")){
                		pageNo =1;
                        getlist('init');
                	}
                	else{
                		//alert(obj["dicId"]);
                		dicTypePageNo =1;
                		getDicTypelist('init',obj["dicId"]);
                		setfieldjqpage();
                	}
                    layer.msg(msg+'成功！');
                }
            },
            error:function (data) {
                layer.msg(msg+'失败！');
            }
        });
    }
    // 获取信息
    function getform(id,htmlstr,title,type){
        $.ajax({
            url: addr + "/api/sys/dictionary/"+ id,
            type: "GET",
            success:function (data) {
                layerfn(htmlstr,title,type);
                console.log(data);
                loadData(data.data);
                if(type == 'view'){
                    $('input,select,textarea',$('form[name="'+myid+'form"]')).prop('readonly',true);
                }
            },
            error:function (data) {
                layer.msg('获取信息失败！');
            }
        });
    }
    
    function getDicTypeForm(id,htmlstr,title,type){
        $.ajax({
            url: addr + "/api/sys/dictype/"+ id,
            type: "GET",
            success:function (data) {
            	layerfnDicType(htmlstr,title,type);
                console.log(data);
                loadDataDicType(data.data);
                if(type == 'view'){
                    $('input,select,textarea',$('form[name="'+myid+'form"]')).prop('readonly',true);
                }
            },
            error:function (data) {
                layer.msg('获取信息失败！');
            }
        });
    }
    // 删除信息
    function dellist(id) {
        console.log(id);
        layer.confirm('是否要删除此条信息？', {
            btn: ['删除','取消'] //按钮
        }, function(){
            $.ajax({
                url:addr+'/api/sys/dictionary/delete/'+id,
                type:'DELETE',
                success:function (data) {
                    if(data.ok){
                        getlist('init');
                        layer.msg('删除成功！');
                    }
                    
                }
            });
        });
    }
    
    function dellistDictype(id) {
       // alert(id);
        layer.confirm('是否要删除此条信息？', {
            btn: ['删除','取消'] //按钮
        }, function(){
            $.ajax({
                url:addr+'/api/sys/dictype/delete/'+id,
                type:'DELETE',
                success:function (data) {
                    if(data.ok){
                    	getDicTypelist('init',$("input[name='checkboxes']:checked").val());
                        layer.msg('删除成功！');
                    }
                }
            });
        });
    }
    // 加载信息
    function loadData(obj) {
           var cur = obj;
           $($("#rolecrud").find("input")[0]).val(cur.id);
           $($("#rolecrud").find("input")[1]).val(cur.dictionaryName);
           $($("#rolecrud").find("input")[2]).val(cur.dictionaryCode);
    }
    
    function loadDataDicType(obj) {
        var cur = obj;
        $($("#dicTypeCrud").find("input")[0]).val(cur.id);
        $($("#dicTypeCrud").find("input")[1]).val(cur.dicTypeName);
        $($("#dicTypeCrud").find("input")[2]).val(cur.dicTypeCode);
 	}

    $(".form_datetime").datetimepicker({
        format: 'yyyy-mm-dd',
        keyboardNavigation: true,
        language: 'zh',
        weekStart: 1,
        startView: 2,
        minView: 2,
        forceParse: 0,
        pickerPosition: (App.isRTL() ? "bottom-right" : "bottom-left"),
        autoclose: true,
        clearBtn:true,
        todayBtn: true
    });

</script>

